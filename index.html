<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="LearnFlow - Swipe to learn. Your personalized knowledge companion.">
  <title>LearnFlow</title>
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTGVhcm5GbG93IEFJIiwic2hvcnRfbmFtZSI6IkxlYXJuRmxvdyIsInN0YXJ0X3VybCI6Ii4vaW5kZXguaHRtbCIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDAwMDAiLCJ0aGVtZV9jb2xvciI6IiMwMDAwMDAiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0IiwiZGVzY3JpcHRpb24iOiJTd2lwZSB0byBsZWFybi4gWW91ciBwZXJzb25hbGl6ZWQga25vd2xlZGdlIGNvbXBhbmlvbi4iLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyUzRSUzQ2RlZnMlM0UlM0NsaW5lYXJHcmFkaWVudCBpZD0nZycgeDElM0QnMCUyNScgeTElM0QnMCUyNScgeDIlM0QnMTAwJTI1JyB5MiUzRCcxMDAlMjUnJTNFJTNDc3RvcCBvZmZzZXQlM0QnMCUyNScgc3R5bGUlM0Qnc3RvcC1jb2xvcjolMjNGRjZCOUI7c3RvcC1vcGFjaXR5OjEnLyUzRSUzQ3N0b3Agb2Zmc2V0JTNEJzEwMCUyNScgc3R5bGUlM0Qnc3RvcC1jb2xvcjolMjNGODZCNkI7c3RvcC1vcGFjaXR5OjEnLyUzRSUzQy9saW5lYXJHcmFkaWVudCUzRSUzQy9kZWZzJTNFJTNDcmVjdCB3aWR0aCUzRCc1MTInIGhlaWdodCUzRCc1MTInIGZpbGwlM0QndXJsKCUyM2cpJy8lM0UlM0NwYXRoIGQlM0QnTTI1NiAxMjhMMTkyIDIyNGg2NGw2NCAxMjhsNjQtMTI4aDY0eicgZmlsbCUzRCclMjNGRkYnLyUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XSwic2hvcnRjdXRzIjpbeyJuYW1lIjoiRmVlZCIsInVybCI6Ii4vP3ZpZXc9ZmVlZCJ9LHsibmFtZSI6Iktub3dsZWRnZSIsInVybCI6Ii4vP3ZpZXc9a25vd2xlZGdlIn0seyJuYW1lIjoiUHJvZ3Jlc3MiLCJ1cmwiOiIuLz92aWV3PXByb2ZpbGUifV0sInNoYXJlX3RhcmdldCI6eyJhY3Rpb24iOiIuLz92aWV3PWZlZWQiLCJtZXRob2QiOiJHRVQiLCJlbmN0eXBlIjoiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIiwicGFyYW1zIjp7InRpdGxlIjoidGl0bGUiLCJ0ZXh0IjoidGV4dCIsInVybCI6InVybCJ9fX0=">
  
  <style>
    /* ============================================
       DESIGN SYSTEM - Easy on Eyes Color Palette
       ============================================ */
    :root {
      /* Base Colors - Soft Dark Theme */
      --color-bg-primary: #0A0A0A;
      --color-bg-secondary: #121212;
      --color-bg-tertiary: #1A1A1A;
      --color-bg-elevated: #232323;
      
      /* Accent Colors - Warm Gradient */
      --color-accent-primary: #FF6B9B;
      --color-accent-secondary: #F86B6B;
      --color-accent-tertiary: #FFB347;
      --color-accent-success: #4ECDC4;
      --color-accent-info: #95E1D3;
      
      /* Text Colors - High Contrast but Soft */
      --color-text-primary: #FFFFFF;
      --color-text-secondary: #B8B8B8;
      --color-text-tertiary: #808080;
      --color-text-muted: #5A5A5A;
      
      /* UI Elements */
      --color-border: rgba(255, 255, 255, 0.08);
      --color-border-hover: rgba(255, 107, 155, 0.3);
      --color-overlay: rgba(0, 0, 0, 0.85);
      --color-glass: rgba(18, 18, 18, 0.7);
      
      /* Shadows */
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
      --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.7);
      
      /* Blur Effects */
      --blur-sm: 8px;
      --blur-md: 16px;
      --blur-lg: 24px;
      
      /* Spacing System */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      --space-16: 4rem;
      
      /* Typography */
      --font-display: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", system-ui, sans-serif;
      --font-body: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", system-ui, sans-serif;
      --font-mono: "SF Mono", "Fira Code", "Consolas", monospace;
      
      /* Font Sizes */
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 1.875rem;
      --text-4xl: 2.25rem;
      --text-5xl: 3rem;
      
      /* Animations */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 400ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-bounce: 500ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
      
      /* Z-Index Scale */
      --z-base: 1;
      --z-dropdown: 100;
      --z-sticky: 200;
      --z-fixed: 300;
      --z-modal: 400;
      --z-toast: 500;
      --z-tooltip: 600;
    }
    
    /* Light Mode Support */
    @media (prefers-color-scheme: light) {
      :root {
        --color-bg-primary: #FFFFFF;
        --color-bg-secondary: #F8F8F8;
        --color-bg-tertiary: #F0F0F0;
        --color-bg-elevated: #FFFFFF;
        --color-text-primary: #0A0A0A;
        --color-text-secondary: #4A4A4A;
        --color-text-tertiary: #6A6A6A;
        --color-text-muted: #9A9A9A;
        --color-border: rgba(0, 0, 0, 0.08);
        --color-overlay: rgba(255, 255, 255, 0.95);
        --color-glass: rgba(255, 255, 255, 0.8);
      }
    }
    
    /* ============================================
       RESET & BASE STYLES
       ============================================ */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    body {
      font-family: var(--font-body);
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
      overscroll-behavior: none;
      touch-action: pan-y pinch-zoom;
    }
    
    /* Safe Area for Notch Devices */
    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    
    /* ============================================
       APP CONTAINER
       ============================================ */
    #app {
      width: 100%;
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    
    /* ============================================
       FEED VIEW - TikTok Style
       ============================================ */
    .feed-viewport {
      flex: 1;
      position: relative;
      overflow: hidden;
      width: 100%;
    }
    
    .feed-container {
      width: 100%;
      height: 100%;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      scroll-behavior: smooth;
    }
    
    .feed-container::-webkit-scrollbar {
      display: none;
    }
    
    .feed-card {
      width: 100%;
      height: 100%;
      height: 100dvh;
      scroll-snap-align: start;
      scroll-snap-stop: always;
      position: relative;
      display: flex;
      flex-direction: column;
      background: var(--color-bg-primary);
      overflow: hidden;
    }
    
    /* Card Background Gradient */
    .card-bg-gradient {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(
        ellipse at top,
        rgba(255, 107, 155, 0.05) 0%,
        transparent 60%
      );
      pointer-events: none;
      opacity: 0;
      transition: opacity var(--transition-slow);
    }
    
    .feed-card.active .card-bg-gradient {
      opacity: 1;
    }
    
    /* Card Content Area */
    .card-content-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: var(--space-6);
      padding-bottom: calc(var(--space-6) + 80px);
      position: relative;
      z-index: 2;
    }
    
    /* Category Badge */
    .card-category {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--color-glass);
      backdrop-filter: blur(var(--blur-md));
      border: 1px solid var(--color-border);
      border-radius: 100px;
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-accent-primary);
      margin-bottom: var(--space-4);
      width: fit-content;
      animation: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s backwards;
    }
    
    /* Card Title */
    .card-title {
      font-family: var(--font-display);
      font-size: clamp(1.75rem, 6vw, 2.75rem);
      font-weight: 800;
      line-height: 1.1;
      letter-spacing: -0.02em;
      margin-bottom: var(--space-4);
      color: var(--color-text-primary);
      text-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
      animation: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
    }
    
    /* Card Summary */
    .card-summary {
      font-size: var(--text-lg);
      line-height: 1.6;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-5);
      max-height: 8em;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      text-shadow: 0 1px 8px rgba(0, 0, 0, 0.4);
      animation: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.3s backwards;
    }
    
    /* Card Meta Info */
    .card-meta {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-tertiary);
      animation: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.4s backwards;
    }
    
    .card-meta-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .card-meta-icon {
      font-size: var(--text-base);
    }
    
    /* Tags */
    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-top: var(--space-4);
      animation: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.5s backwards;
    }
    
    .tag {
      padding: var(--space-2) var(--space-3);
      background: rgba(255, 107, 155, 0.15);
      border: 1px solid rgba(255, 107, 155, 0.3);
      border-radius: 6px;
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--color-accent-primary);
      backdrop-filter: blur(var(--blur-sm));
      transition: all var(--transition-fast);
    }
    
    .tag:active {
      transform: scale(0.95);
      background: rgba(255, 107, 155, 0.25);
    }
    
    /* Side Action Bar - TikTok Style */
    .side-actions {
      position: absolute;
      right: var(--space-4);
      bottom: calc(var(--space-6) + 100px);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      z-index: 10;
    }
    
    .action-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--color-glass);
      backdrop-filter: blur(var(--blur-md));
      border: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--color-text-primary);
      font-size: var(--text-xl);
      cursor: pointer;
      transition: all var(--transition-fast);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    .action-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, var(--color-accent-primary) 0%, transparent 70%);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }
    
    .action-btn:active {
      transform: scale(0.9);
    }
    
    .action-btn:active::before {
      opacity: 0.2;
    }
    
    .action-btn.active {
      background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
      border-color: var(--color-accent-primary);
      color: white;
      animation: pulse 0.6s ease-out;
    }
    
    .action-count {
      font-size: var(--text-xs);
      font-weight: 700;
      margin-top: var(--space-1);
      color: var(--color-text-secondary);
    }
    
    .action-btn.active .action-count {
      color: white;
    }
    
    /* Bottom Navigation - TikTok Style */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: var(--color-glass);
      backdrop-filter: blur(var(--blur-lg));
      border-top: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-around;
      padding: 0 var(--space-4);
      z-index: var(--z-fixed);
      box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.5);
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-1);
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--transition-fast);
      padding: var(--space-2);
      position: relative;
      flex: 1;
    }
    
    .nav-item.active {
      color: var(--color-accent-primary);
    }
    
    .nav-icon {
      font-size: 24px;
      transition: transform var(--transition-fast);
    }
    
    .nav-item:active .nav-icon {
      transform: scale(0.85);
    }
    
    .nav-label {
      font-size: var(--text-xs);
      font-weight: 600;
    }
    
    .nav-badge {
      position: absolute;
      top: 0;
      right: 20%;
      background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
      box-shadow: var(--shadow-sm);
    }
    
    /* ============================================
       EXPANDED CONTENT VIEW
       ============================================ */
    .expanded-content {
      position: fixed;
      top: 100%;
      left: 0;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background: var(--color-bg-primary);
      z-index: var(--z-modal);
      transition: transform var(--transition-slow);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .expanded-content.visible {
      transform: translateY(-100%);
    }
    
    .expanded-header {
      position: sticky;
      top: 0;
      background: var(--color-glass);
      backdrop-filter: blur(var(--blur-lg));
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }
    
    .expanded-close {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--color-bg-tertiary);
      border: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .expanded-close:active {
      transform: scale(0.9);
    }
    
    .expanded-body {
      padding: var(--space-6);
      max-width: 680px;
      margin: 0 auto;
    }
    
    .expanded-text {
      font-size: var(--text-lg);
      line-height: 1.8;
      color: var(--color-text-secondary);
    }
    
    .expanded-text p {
      margin-bottom: var(--space-6);
    }
    
    .expanded-text h2 {
      font-size: var(--text-2xl);
      font-weight: 700;
      margin: var(--space-8) 0 var(--space-4);
      color: var(--color-text-primary);
    }
    
    .expanded-text h3 {
      font-size: var(--text-xl);
      font-weight: 600;
      margin: var(--space-6) 0 var(--space-3);
      color: var(--color-text-primary);
    }
    
    /* ============================================
       KNOWLEDGE VIEW
       ============================================ */
    .knowledge-view {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--color-bg-primary);
      z-index: var(--z-dropdown);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-base);
      overflow-y: auto;
    }
    
    .knowledge-view.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .knowledge-header {
      position: sticky;
      top: 0;
      background: var(--color-glass);
      backdrop-filter: blur(var(--blur-lg));
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-4);
      z-index: 10;
    }
    
    .knowledge-title {
      font-family: var(--font-display);
      font-size: var(--text-3xl);
      font-weight: 800;
      margin-bottom: var(--space-4);
      background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .search-wrapper {
      position: relative;
      margin-bottom: var(--space-4);
    }
    
    .search-input {
      width: 100%;
      height: 48px;
      padding: 0 var(--space-4) 0 48px;
      background: var(--color-bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 24px;
      font-size: var(--text-base);
      color: var(--color-text-primary);
      transition: all var(--transition-fast);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--color-accent-primary);
      background: var(--color-bg-secondary);
      box-shadow: 0 0 0 4px rgba(255, 107, 155, 0.1);
    }
    
    .search-icon {
      position: absolute;
      left: var(--space-4);
      top: 50%;
      transform: translateY(-50%);
      font-size: var(--text-xl);
      color: var(--color-text-tertiary);
      pointer-events: none;
    }
    
    .filter-tabs {
      display: flex;
      gap: var(--space-2);
      overflow-x: auto;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }
    
    .filter-tabs::-webkit-scrollbar {
      display: none;
    }
    
    .filter-tab {
      padding: var(--space-2) var(--space-4);
      background: var(--color-bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 20px;
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
      white-space: nowrap;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .filter-tab.active {
      background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
      border-color: transparent;
      color: white;
    }
    
    .knowledge-grid {
      padding: var(--space-4);
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: var(--space-3);
    }
    
    .knowledge-card {
      aspect-ratio: 0.75;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      padding: var(--space-4);
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .knowledge-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--color-accent-primary), var(--color-accent-secondary));
      transform: translateY(-4px);
      transition: transform var(--transition-fast);
    }
    
    .knowledge-card:active {
      transform: scale(0.96);
    }
    
    .knowledge-card:active::before {
      transform: translateY(0);
    }
    
    .knowledge-card-title {
      font-weight: 700;
      font-size: var(--text-sm);
      margin-bottom: var(--space-2);
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      flex: 1;
    }
    
    .knowledge-card-date {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }
    
    /* ============================================
       PROFILE/STATS VIEW
       ============================================ */
    .profile-view {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--color-bg-primary);
      z-index: var(--z-dropdown);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-base);
      overflow-y: auto;
    }
    
    .profile-view.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .profile-hero {
      padding: var(--space-8) var(--space-6);
      background: linear-gradient(135deg, rgba(255, 107, 155, 0.15), rgba(248, 107, 107, 0.15));
      border-bottom: 1px solid var(--color-border);
      text-align: center;
    }
    
    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
      margin: 0 auto var(--space-4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-5xl);
      box-shadow: var(--shadow-lg);
      animation: float 3s ease-in-out infinite;
    }
    
    .profile-level {
      font-size: var(--text-sm);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-accent-primary);
      margin-bottom: var(--space-2);
    }
    
    .profile-xp {
      font-size: var(--text-5xl);
      font-weight: 800;
      background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--space-2);
    }
    
    .profile-rank {
      font-size: var(--text-xl);
      color: var(--color-text-secondary);
      font-weight: 600;
    }
    
    .streak-display {
      margin-top: var(--space-6);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-6);
      background: rgba(255, 107, 155, 0.2);
      border: 1px solid rgba(255, 107, 155, 0.4);
      border-radius: 100px;
      font-weight: 700;
      font-size: var(--text-lg);
    }
    
    .stats-container {
      padding: var(--space-6);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-4);
      margin-bottom: var(--space-8);
    }
    
    .stat-card {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      padding: var(--space-5);
      text-align: center;
    }
    
    .stat-value {
      font-size: var(--text-4xl);
      font-weight: 800;
      background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--space-2);
    }
    
    .stat-label {
      font-size: var(--text-sm);
      color: var(--color-text-tertiary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .progress-section {
      margin-bottom: var(--space-8);
    }
    
    .section-title {
      font-size: var(--text-xl);
      font-weight: 700;
      margin-bottom: var(--space-4);
      color: var(--color-text-primary);
    }
    
    .progress-card {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      padding: var(--space-5);
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
    }
    
    .progress-title {
      font-weight: 600;
      color: var(--color-text-primary);
    }
    
    .progress-percentage {
      font-weight: 700;
      color: var(--color-accent-primary);
    }
    
    .progress-bar {
      height: 8px;
      background: var(--color-bg-tertiary);
      border-radius: 100px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--color-accent-primary), var(--color-accent-secondary));
      border-radius: 100px;
      transition: width var(--transition-slow);
    }
    
    .achievements-section {
      margin-bottom: var(--space-8);
    }
    
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-3);
    }
    
    .achievement-card {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      padding: var(--space-4);
      text-align: center;
      transition: all var(--transition-fast);
      cursor: pointer;
    }
    
    .achievement-card.unlocked {
      background: linear-gradient(135deg, rgba(255, 107, 155, 0.15), rgba(248, 107, 107, 0.15));
      border-color: rgba(255, 107, 155, 0.4);
    }
    
    .achievement-card.locked {
      opacity: 0.4;
      filter: grayscale(1);
    }
    
    .achievement-icon {
      font-size: var(--text-4xl);
      margin-bottom: var(--space-2);
    }
    
    .achievement-name {
      font-size: var(--text-xs);
      font-weight: 700;
      color: var(--color-text-secondary);
    }
    
    /* ============================================
       SETTINGS PANEL
       ============================================ */
    .settings-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--color-bg-primary);
      z-index: var(--z-modal);
      transform: translateX(100%);
      transition: transform var(--transition-slow);
      overflow-y: auto;
    }
    
    .settings-panel.visible {
      transform: translateX(0);
    }
    
    .settings-header {
      position: sticky;
      top: 0;
      background: var(--color-glass);
      backdrop-filter: blur(var(--blur-lg));
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-4);
      z-index: 10;
    }
    
    .settings-back {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--color-bg-tertiary);
      border: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      cursor: pointer;
    }
    
    .settings-title {
      font-size: var(--text-2xl);
      font-weight: 700;
    }
    
    .settings-content {
      padding: var(--space-6);
    }
    
    .setting-group {
      margin-bottom: var(--space-8);
    }
    
    .setting-group-title {
      font-size: var(--text-lg);
      font-weight: 700;
      margin-bottom: var(--space-4);
      color: var(--color-text-primary);
    }
    
    .setting-item {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: var(--space-4);
      margin-bottom: var(--space-3);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .setting-info {
      flex: 1;
    }
    
    .setting-label {
      font-weight: 600;
      margin-bottom: var(--space-1);
    }
    
    .setting-desc {
      font-size: var(--text-sm);
      color: var(--color-text-tertiary);
    }
    
    .toggle-switch {
      width: 52px;
      height: 30px;
      background: var(--color-bg-tertiary);
      border-radius: 15px;
      position: relative;
      cursor: pointer;
      transition: background var(--transition-fast);
    }
    
    .toggle-switch.active {
      background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
    }
    
    .toggle-slider {
      width: 26px;
      height: 26px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform var(--transition-fast);
      box-shadow: var(--shadow-sm);
    }
    
    .toggle-switch.active .toggle-slider {
      transform: translateX(22px);
    }
    
    /* ============================================
       MODAL SYSTEM
       ============================================ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--color-overlay);
      backdrop-filter: blur(var(--blur-sm));
      z-index: var(--z-modal);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-6);
    }
    
    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .modal {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      transform: scale(0.9) translateY(20px);
      opacity: 0;
      transition: all var(--transition-slow);
      box-shadow: var(--shadow-xl);
    }
    
    .modal-overlay.active .modal {
      transform: scale(1) translateY(0);
      opacity: 1;
    }
    
    .modal-header {
      padding: var(--space-6);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-title {
      font-size: var(--text-2xl);
      font-weight: 700;
    }
    
    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--color-bg-tertiary);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .modal-close:active {
      transform: scale(0.9);
    }
    
    .modal-body {
      padding: var(--space-6);
    }
    
    .form-group {
      margin-bottom: var(--space-5);
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--space-2);
      color: var(--color-text-primary);
    }
    
    .form-input,
    .form-textarea {
      width: 100%;
      padding: var(--space-4);
      background: var(--color-bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      font-size: var(--text-base);
      color: var(--color-text-primary);
      font-family: var(--font-body);
      transition: all var(--transition-fast);
    }
    
    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--color-accent-primary);
      box-shadow: 0 0 0 4px rgba(255, 107, 155, 0.1);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-4) var(--space-6);
      border-radius: 12px;
      font-weight: 700;
      font-size: var(--text-base);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      width: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
      color: white;
      box-shadow: var(--shadow-md);
    }
    
    .btn-primary:active {
      transform: translateY(2px);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-secondary {
      background: var(--color-bg-tertiary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
    }
    
    .btn-secondary:active {
      transform: scale(0.98);
    }
    
    /* ============================================
       TOAST NOTIFICATIONS
       ============================================ */
    .toast-container {
      position: fixed;
      top: calc(env(safe-area-inset-top) + var(--space-4));
      left: var(--space-4);
      right: var(--space-4);
      z-index: var(--z-toast);
      pointer-events: none;
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    
    .toast {
      background: var(--color-glass);
      backdrop-filter: blur(var(--blur-lg));
      border: 1px solid var(--color-border);
      border-radius: 16px;
      padding: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      box-shadow: var(--shadow-lg);
      pointer-events: auto;
      transform: translateY(-100px);
      opacity: 0;
      animation: toastIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
    
    .toast.success {
      border-left: 4px solid var(--color-accent-success);
    }
    
    .toast.error {
      border-left: 4px solid var(--color-accent-secondary);
    }
    
    .toast-icon {
      font-size: var(--text-2xl);
    }
    
    .toast-message {
      flex: 1;
      font-weight: 600;
    }
    
    /* ============================================
       LOADING STATES
       ============================================ */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-12);
      height: 100%;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--color-border);
      border-top-color: var(--color-accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--space-4);
    }
    
    .loading-text {
      color: var(--color-text-tertiary);
      font-size: var(--text-sm);
    }
    
    .skeleton {
      background: linear-gradient(
        90deg,
        var(--color-bg-secondary) 0%,
        var(--color-bg-tertiary) 50%,
        var(--color-bg-secondary) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    
    /* ============================================
       EMPTY STATES
       ============================================ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-12);
      text-align: center;
      height: 100%;
    }
    
    .empty-icon {
      font-size: 80px;
      margin-bottom: var(--space-6);
      opacity: 0.3;
    }
    
    .empty-title {
      font-size: var(--text-2xl);
      font-weight: 700;
      margin-bottom: var(--space-2);
    }
    
    .empty-desc {
      font-size: var(--text-base);
      color: var(--color-text-tertiary);
      margin-bottom: var(--space-6);
    }
    
    /* ============================================
       ANIMATIONS
       ============================================ */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    @keyframes shimmer {
      to {
        background-position: -200% 0;
      }
    }
    
    @keyframes toastIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }
    
    /* ============================================
       ACCESSIBILITY
       ============================================ */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Focus visible for keyboard navigation */
    *:focus-visible {
      outline: 2px solid var(--color-accent-primary);
      outline-offset: 2px;
    }
    
    /* ============================================
       RESPONSIVE BREAKPOINTS
       ============================================ */
    @media (min-width: 768px) {
      .knowledge-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: var(--space-4);
      }
      
      .achievements-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    /* ============================================
       UTILITY CLASSES
       ============================================ */
    .hidden {
      display: none !important;
    }
    
    .invisible {
      opacity: 0 !important;
      pointer-events: none !important;
    }
    
    .no-scroll {
      overflow: hidden !important;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Feed View -->
    <div class="feed-viewport" id="feed-viewport">
      <div class="feed-container" id="feed-container">
        <div class="loading-container">
          <div class="spinner"></div>
          <div class="loading-text">Loading your personalized feed...</div>
        </div>
      </div>
    </div>
    
    <!-- Knowledge View -->
    <div class="knowledge-view" id="knowledge-view">
      <div class="knowledge-header">
        <h1 class="knowledge-title">My Knowledge</h1>
        <div class="search-wrapper">
          <div class="search-icon">üîç</div>
          <input type="text" class="search-input" id="search-input" placeholder="Search everything...">
        </div>
        <div class="filter-tabs">
          <div class="filter-tab active" data-filter="all">All</div>
          <div class="filter-tab" data-filter="saved">Saved</div>
          <div class="filter-tab" data-filter="notes">Notes</div>
          <div class="filter-tab" data-filter="recent">Recent</div>
        </div>
      </div>
      <div class="knowledge-grid" id="knowledge-grid"></div>
    </div>
    
    <!-- Profile View -->
    <div class="profile-view" id="profile-view">
      <div class="profile-hero">
        <div class="profile-avatar">üéì</div>
        <div class="profile-level">Level <span id="user-level">1</span></div>
        <div class="profile-xp"><span id="user-xp">0</span></div>
        <div class="profile-rank" id="user-rank">Curious Learner</div>
        <div class="streak-display">
          üî• <span id="user-streak">0</span> day streak
        </div>
      </div>
      
      <div class="stats-container">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-learned">0</div>
            <div class="stat-label">Learned</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-saved">0</div>
            <div class="stat-label">Saved</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-notes">0</div>
            <div class="stat-label">Notes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-time">0</div>
            <div class="stat-label">Minutes</div>
          </div>
        </div>
        
        <div class="progress-section">
          <h2 class="section-title">Daily Goal</h2>
          <div class="progress-card">
            <div class="progress-header">
              <div class="progress-title">Learning Progress</div>
              <div class="progress-percentage"><span id="daily-progress">0</span>%</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="daily-progress-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>
        
        <div class="achievements-section">
          <h2 class="section-title">Achievements</h2>
          <div class="achievements-grid" id="achievements-grid"></div>
        </div>
        
        <button class="btn btn-secondary" id="settings-btn">‚öôÔ∏è Settings</button>
      </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <div class="nav-item active" data-view="feed">
        <div class="nav-icon">üè†</div>
        <div class="nav-label">Feed</div>
      </div>
      <div class="nav-item" data-view="knowledge">
        <div class="nav-icon">üìö</div>
        <div class="nav-label">Library</div>
        <div class="nav-badge" id="library-badge">0</div>
      </div>
      <div class="nav-item" id="add-note-nav">
        <div class="nav-icon" style="font-size: 32px;">‚ûï</div>
      </div>
      <div class="nav-item" data-view="profile">
        <div class="nav-icon">üë§</div>
        <div class="nav-label">Progress</div>
      </div>
      <div class="nav-item" id="settings-nav">
        <div class="nav-icon">‚öôÔ∏è</div>
        <div class="nav-label">Settings</div>
      </div>
    </div>
    
    <!-- Expanded Content Panel -->
    <div class="expanded-content" id="expanded-content">
      <div class="expanded-header">
        <div class="expanded-close" id="expanded-close">‚úï</div>
        <div style="flex: 1;"></div>
        <button class="btn btn-primary" id="expanded-save" style="width: auto; padding: var(--space-2) var(--space-4);">
          üíæ Save
        </button>
      </div>
      <div class="expanded-body" id="expanded-body"></div>
    </div>
    
    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
      <div class="settings-header">
        <div class="settings-back" id="settings-back">‚Üê</div>
        <div class="settings-title">Settings</div>
      </div>
      <div class="settings-content">
        <div class="setting-group">
          <div class="setting-group-title">Preferences</div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-label">Daily Goal</div>
              <div class="setting-desc">Number of items to learn per day</div>
            </div>
            <select id="daily-goal-select" style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 8px; padding: var(--space-2) var(--space-3); color: var(--color-text-primary);">
              <option value="5">5 items</option>
              <option value="10" selected>10 items</option>
              <option value="15">15 items</option>
              <option value="20">20 items</option>
            </select>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-label">Auto-play TTS</div>
              <div class="setting-desc">Read content aloud automatically</div>
            </div>
            <div class="toggle-switch" id="tts-toggle">
              <div class="toggle-slider"></div>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-label">Dark Mode</div>
              <div class="setting-desc">Use dark theme</div>
            </div>
            <div class="toggle-switch active" id="dark-mode-toggle">
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>
        
        <div class="setting-group">
          <div class="setting-group-title">Data</div>
          <button class="btn btn-secondary" id="export-btn">üì• Export All Data</button>
          <button class="btn btn-secondary" id="import-btn" style="margin-top: var(--space-3);">üì§ Import Data</button>
          <input type="file" id="import-file" accept=".json" style="display: none;">
        </div>
        
        <div class="setting-group">
          <div class="setting-group-title">About</div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-label">Version</div>
              <div class="setting-desc">LearnFlow v2.0.0</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title" id="modal-title">Modal</div>
          <button class="modal-close" id="modal-close">‚úï</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
      </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
  </div>
  
  <script>
    (function() {
      'use strict';
      
      // ============================================
      // CONFIGURATION
      // ============================================
      const CONFIG = {
        DB_NAME: 'LearnFlowDB',
        DB_VERSION: 2,
        CACHE_NAME: 'learnflow-v2',
        FEED_BATCH_SIZE: 10,
        DAILY_GOAL_DEFAULT: 10,
        XP: {
          READ: 10,
          SAVE: 25,
          NOTE: 50,
          STREAK: 100
        },
        LEVEL: {
          BASE_XP: 100,
          MULTIPLIER: 1.5
        }
      };
      
      // ============================================
      // STORAGE MANAGER
      // ============================================
      class Storage {
        constructor() {
          this.db = null;
        }
        
        async init() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
              this.db = request.result;
              resolve();
            };
            
            request.onupgradeneeded = (e) => {
              const db = e.target.result;
              
              const stores = ['saved_items', 'notes', 'user_model', 'achievements', 'settings', 'feed_cache'];
              
              stores.forEach(name => {
                if (!db.objectStoreNames.contains(name)) {
                  const store = db.createObjectStore(name, { keyPath: 'id', autoIncrement: true });
                  if (name === 'saved_items' || name === 'notes') {
                    store.createIndex('timestamp', 'timestamp');
                    store.createIndex('tags', 'tags', { multiEntry: true });
                  }
                  if (name === 'feed_cache') {
                    store.createIndex('timestamp', 'timestamp');
                  }
                }
              });
            };
          });
        }
        
        async getAll(storeName) {
          return new Promise((resolve, reject) => {
            const tx = this.db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        }
        
        async get(storeName, key) {
          return new Promise((resolve, reject) => {
            const tx = this.db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const request = store.get(key);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        }
        
        async put(storeName, data) {
          return new Promise((resolve, reject) => {
            const tx = this.db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const request = store.put(data);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        }
        
        async delete(storeName, key) {
          return new Promise((resolve, reject) => {
            const tx = this.db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const request = store.delete(key);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        }
      }
      
      // ============================================
      // CONTENT FETCHER
      // ============================================
      class ContentFetcher {
        constructor() {
          this.lastFetch = 0;
        }
        
        async fetchWikipedia() {
          try {
            const response = await fetch('https://en.wikipedia.org/api/rest_v1/page/random/summary');
            if (!response.ok) return null;
            const data = await response.json();
            
            return {
              source: 'Wikipedia',
              category: 'Knowledge',
              title: data.title,
              summary: data.extract,
              content: data.extract,
              url: data.content_urls?.desktop?.page || '',
              tags: this.extractTags(data.title + ' ' + data.extract),
              readingTime: this.estimateReadingTime(data.extract),
              timestamp: Date.now()
            };
          } catch (e) {
            return null;
          }
        }
        
        generateFallback() {
          const content = [
            {
              category: 'Psychology',
              title: 'The Peak-End Rule',
              summary: 'People judge experiences based on their peak (most intense point) and ending, not the average of every moment. This explains why a painful medical procedure with a less painful ending is remembered more favorably than a shorter, more painful one.',
              tags: ['psychology', 'memory', 'bias']
            },
            {
              category: 'Science',
              title: 'Quantum Entanglement',
              summary: 'When particles become entangled, measuring the state of one instantly affects the other, regardless of distance. Einstein called it "spooky action at a distance," yet it\'s fundamental to quantum computing and cryptography.',
              tags: ['physics', 'quantum', 'technology']
            },
            {
              category: 'History',
              title: 'The Library of Alexandria',
              summary: 'The ancient Library of Alexandria was the largest repository of knowledge in the ancient world. Its destruction, occurring over several centuries through various incidents, represents one of history\'s greatest losses of knowledge.',
              tags: ['history', 'library', 'knowledge']
            },
            {
              category: 'Biology',
              title: 'Neuroplasticity',
              summary: 'The brain\'s ability to reorganize itself by forming new neural connections throughout life. This adaptability allows learning, recovery from injury, and adaptation to new experiences at any age.',
              tags: ['neuroscience', 'learning', 'brain']
            },
            {
              category: 'Philosophy',
              title: 'The Ship of Theseus',
              summary: 'If all components of a ship are gradually replaced, is it still the same ship? This ancient paradox explores questions of identity, change, and what makes something fundamentally itself.',
              tags: ['philosophy', 'identity', 'paradox']
            },
            {
              category: 'Technology',
              title: 'Moore\'s Law',
              summary: 'The observation that the number of transistors on integrated circuits doubles approximately every two years. This exponential growth has driven technological advancement for decades, though physical limits are now being approached.',
              tags: ['technology', 'computing', 'innovation']
            },
            {
              category: 'Economics',
              title: 'The Paradox of Thrift',
              summary: 'When everyone saves more during economic downturns, aggregate demand falls, leading to lower economic growth and potentially less total savings. Individual rationality can lead to collective irrationality.',
              tags: ['economics', 'paradox', 'saving']
            },
            {
              category: 'Art',
              title: 'The Golden Ratio',
              summary: 'Approximately 1.618, this mathematical ratio appears in nature, architecture, and art. From the Parthenon to Renaissance paintings, artists have used it to create aesthetically pleasing compositions.',
              tags: ['mathematics', 'art', 'nature']
            },
            {
              category: 'Space',
              title: 'The Fermi Paradox',
              summary: 'Given the vast number of stars and potential for life, where is everybody? This paradox highlights the contradiction between high probability of extraterrestrial civilizations and lack of evidence for them.',
              tags: ['space', 'paradox', 'aliens']
            },
            {
              category: 'Learning',
              title: 'Spaced Repetition',
              summary: 'Reviewing information at increasing intervals dramatically improves long-term retention. This technique leverages the spacing effect, a phenomenon where learning is more effective when study sessions are spaced out.',
              tags: ['learning', 'memory', 'education']
            }
          ];
          
          const item = content[Math.floor(Math.random() * content.length)];
          return {
            source: 'LearnFlow',
            category: item.category,
            title: item.title,
            summary: item.summary,
            content: item.summary,
            url: '',
            tags: item.tags,
            readingTime: this.estimateReadingTime(item.summary),
            timestamp: Date.now()
          };
        }
        
        async fetch() {
          // Rate limit
          const now = Date.now();
          if (now - this.lastFetch < 1000) {
            return this.generateFallback();
          }
          this.lastFetch = now;
          
          // Try Wikipedia first
          const wiki = await this.fetchWikipedia();
          return wiki || this.generateFallback();
        }
        
        extractTags(text) {
          const words = text.toLowerCase().match(/\b\w{4,}\b/g) || [];
          const freq = {};
          words.forEach(w => freq[w] = (freq[w] || 0) + 1);
          return Object.entries(freq)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([w]) => w);
        }
        
        estimateReadingTime(text) {
          return Math.max(1, Math.ceil(text.split(/\s+/).length / 200));
        }
      }
      
      // ============================================
      // PERSONALIZATION ENGINE
      // ============================================
      class Personalization {
        constructor(storage) {
          this.storage = storage;
          this.model = { likes: {}, skips: {}, reads: {} };
        }
        
        async init() {
          const data = await this.storage.getAll('user_model');
          data.forEach(entry => {
            if (entry.type === 'like') {
              entry.tags?.forEach(tag => {
                this.model.likes[tag] = (this.model.likes[tag] || 0) + 1;
              });
            } else if (entry.type === 'skip') {
              entry.tags?.forEach(tag => {
                this.model.skips[tag] = (this.model.skips[tag] || 0) + 1;
              });
            }
          });
        }
        
        async recordLike(tags) {
          await this.storage.put('user_model', {
            type: 'like',
            tags,
            timestamp: Date.now()
          });
          tags?.forEach(tag => {
            this.model.likes[tag] = (this.model.likes[tag] || 0) + 1;
          });
        }
        
        async recordSkip(tags) {
          await this.storage.put('user_model', {
            type: 'skip',
            tags,
            timestamp: Date.now()
          });
          tags?.forEach(tag => {
            this.model.skips[tag] = (this.model.skips[tag] || 0) + 1;
          });
        }
        
        score(item) {
          let score = 50;
          item.tags?.forEach(tag => {
            if (this.model.likes[tag]) score += this.model.likes[tag] * 10;
            if (this.model.skips[tag]) score -= this.model.skips[tag] * 5;
          });
          return Math.max(0, score);
        }
        
        rank(items) {
          return items.map(item => ({
            ...item,
            score: this.score(item)
          })).sort((a, b) => b.score - a.score);
        }
      }
      
      // ============================================
      // GAMIFICATION ENGINE
      // ============================================
      class Gamification {
        constructor(storage) {
          this.storage = storage;
          this.stats = {
            xp: 0,
            level: 1,
            streak: 0,
            lastActivity: null,
            learned: 0,
            saved: 0,
            notes: 0,
            time: 0,
            dailyGoal: CONFIG.DAILY_GOAL_DEFAULT,
            dailyProgress: 0
          };
          
          this.achievements = [
            { id: 'first_save', name: 'First Steps', icon: '‚≠ê', unlocked: false, desc: 'Save your first item' },
            { id: 'explorer', name: 'Explorer', icon: 'üó∫Ô∏è', unlocked: false, desc: 'Read 10 items' },
            { id: 'scholar', name: 'Scholar', icon: 'üéì', unlocked: false, desc: 'Save 25 items' },
            { id: 'streak_7', name: 'Committed', icon: 'üî•', unlocked: false, desc: '7 day streak' },
            { id: 'master', name: 'Master', icon: 'üëë', unlocked: false, desc: 'Reach level 10' },
            { id: 'writer', name: 'Writer', icon: '‚úçÔ∏è', unlocked: false, desc: 'Create 10 notes' }
          ];
        }
        
        async init() {
          const settings = await this.storage.get('settings', 'stats');
          if (settings?.value) {
            this.stats = { ...this.stats, ...settings.value };
          }
          
          const ach = await this.storage.getAll('achievements');
          ach.forEach(a => {
            const achievement = this.achievements.find(x => x.id === a.id);
            if (achievement) achievement.unlocked = a.unlocked;
          });
          
          this.checkStreak();
        }
        
        checkStreak() {
          const today = new Date().setHours(0, 0, 0, 0);
          const last = this.stats.lastActivity ? new Date(this.stats.lastActivity).setHours(0, 0, 0, 0) : 0;
          const diff = Math.floor((today - last) / (1000 * 60 * 60 * 24));
          
          if (diff === 1) {
            this.stats.streak++;
            this.addXP(CONFIG.XP.STREAK);
          } else if (diff > 1) {
            this.stats.streak = 1;
          }
          
          this.stats.lastActivity = Date.now();
          this.stats.dailyProgress = 0;
          this.save();
        }
        
        addXP(amount) {
          this.stats.xp += amount;
          const required = this.getRequiredXP();
          
          if (this.stats.xp >= required) {
            this.stats.level++;
            this.stats.xp -= required;
            app.toast('üéâ Level Up! Now level ' + this.stats.level, 'success');
            if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
          }
          
          this.save();
        }
        
        getRequiredXP() {
          return Math.floor(CONFIG.LEVEL.BASE_XP * Math.pow(CONFIG.LEVEL.MULTIPLIER, this.stats.level - 1));
        }
        
        recordRead() {
          this.stats.learned++;
          this.stats.dailyProgress++;
          this.addXP(CONFIG.XP.READ);
          this.checkAchievements();
        }
        
        recordSave() {
          this.stats.saved++;
          this.addXP(CONFIG.XP.SAVE);
          this.checkAchievements();
        }
        
        recordNote() {
          this.stats.notes++;
          this.addXP(CONFIG.XP.NOTE);
          this.checkAchievements();
        }
        
        checkAchievements() {
          this.achievements.forEach(async ach => {
            if (ach.unlocked) return;
            
            let unlock = false;
            if (ach.id === 'first_save' && this.stats.saved >= 1) unlock = true;
            if (ach.id === 'explorer' && this.stats.learned >= 10) unlock = true;
            if (ach.id === 'scholar' && this.stats.saved >= 25) unlock = true;
            if (ach.id === 'streak_7' && this.stats.streak >= 7) unlock = true;
            if (ach.id === 'master' && this.stats.level >= 10) unlock = true;
            if (ach.id === 'writer' && this.stats.notes >= 10) unlock = true;
            
            if (unlock) {
              ach.unlocked = true;
              await this.storage.put('achievements', { id: ach.id, unlocked: true, timestamp: Date.now() });
              app.toast('üèÜ Achievement: ' + ach.name, 'success');
              if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
              app.renderProfile();
            }
          });
        }
        
        getRank() {
          if (this.stats.level >= 20) return 'Grand Master';
          if (this.stats.level >= 15) return 'Expert Scholar';
          if (this.stats.level >= 10) return 'Knowledge Seeker';
          if (this.stats.level >= 5) return 'Avid Learner';
          return 'Curious Learner';
        }
        
        getDailyProgress() {
          return Math.min(100, Math.floor((this.stats.dailyProgress / this.stats.dailyGoal) * 100));
        }
        
        async save() {
          await this.storage.put('settings', {
            id: 'stats',
            value: this.stats
          });
        }
      }
      
      // ============================================
      // SEARCH ENGINE
      // ============================================
      class SearchEngine {
        constructor(storage) {
          this.storage = storage;
          this.index = {};
        }
        
        async buildIndex() {
          const items = await this.storage.getAll('saved_items');
          const notes = await this.storage.getAll('notes');
          
          this.index = {};
          
          [...items, ...notes].forEach(item => {
            const text = ((item.title || '') + ' ' + (item.content || '') + ' ' + (item.tags?.join(' ') || '')).toLowerCase();
            const words = text.match(/\b\w+\b/g) || [];
            
            words.forEach(word => {
              if (word.length < 3) return;
              if (!this.index[word]) this.index[word] = new Set();
              this.index[word].add(item.id);
            });
          });
        }
        
        async search(query) {
          if (!query) return [];
          
          const terms = query.toLowerCase().match(/\b\w+\b/g) || [];
          const results = new Map();
          
          terms.forEach(term => {
            const ids = this.index[term] || new Set();
            ids.forEach(id => {
              results.set(id, (results.get(id) || 0) + 1);
            });
          });
          
          const items = await this.storage.getAll('saved_items');
          const notes = await this.storage.getAll('notes');
          const all = [...items, ...notes];
          
          return Array.from(results.entries())
            .sort((a, b) => b[1] - a[1])
            .map(([id]) => all.find(item => item.id === id))
            .filter(Boolean);
        }
      }
      
      // ============================================
      // MAIN APP
      // ============================================
      class App {
        constructor() {
          this.storage = new Storage();
          this.fetcher = new ContentFetcher();
          this.personalization = null;
          this.gamification = null;
          this.search = null;
          
          this.currentView = 'feed';
          this.feedCache = [];
          this.currentCardIndex = 0;
          this.currentItem = null;
          this.isLoading = false;
        }
        
        async init() {
          try {
            await this.storage.init();
            
            this.personalization = new Personalization(this.storage);
            await this.personalization.init();
            
            this.gamification = new Gamification(this.storage);
            await this.gamification.init();
            
            this.search = new SearchEngine(this.storage);
            await this.search.buildIndex();
            
            this.setupUI();
            this.setupServiceWorker();
            await this.loadFeed();
            this.updateLibraryBadge();
            this.renderProfile();
            
            console.log('‚úÖ LearnFlow initialized');
          } catch (e) {
            console.error('Init error:', e);
            this.toast('Failed to initialize', 'error');
          }
        }
        
        setupUI() {
          // Navigation
          document.querySelectorAll('.nav-item[data-view]').forEach(item => {
            item.addEventListener('click', () => {
              this.switchView(item.dataset.view);
            });
          });
          
          // Add note button
          document.getElementById('add-note-nav').addEventListener('click', () => {
            this.showNoteModal();
          });
          
          // Settings
          document.getElementById('settings-nav').addEventListener('click', () => {
            document.getElementById('settings-panel').classList.add('visible');
          });
          
          document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('settings-panel').classList.add('visible');
          });
          
          document.getElementById('settings-back').addEventListener('click', () => {
            document.getElementById('settings-panel').classList.remove('visible');
          });
          
          // Feed scroll
          const feedContainer = document.getElementById('feed-container');
          feedContainer.addEventListener('scroll', this.debounce(() => {
            this.handleFeedScroll();
          }, 100));
          
          // Expanded content
          document.getElementById('expanded-close').addEventListener('click', () => {
            document.getElementById('expanded-content').classList.remove('visible');
          });
          
          document.getElementById('expanded-save').addEventListener('click', async () => {
            if (this.currentItem) {
              await this.saveItem(this.currentItem);
              this.toast('Saved to library', 'success');
            }
          });
          
          // Modal
          document.getElementById('modal-close').addEventListener('click', () => {
            document.getElementById('modal-overlay').classList.remove('active');
          });
          
          // Search
          document.getElementById('search-input').addEventListener('input', this.debounce((e) => {
            this.handleSearch(e.target.value);
          }, 300));
          
          // Filters
          document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              this.filterKnowledge(tab.dataset.filter);
            });
          });
          
          // Settings toggles
          document.getElementById('tts-toggle').addEventListener('click', (e) => {
            e.currentTarget.classList.toggle('active');
          });
          
          document.getElementById('dark-mode-toggle').addEventListener('click', (e) => {
            e.currentTarget.classList.toggle('active');
          });
          
          // Export/Import
          document.getElementById('export-btn').addEventListener('click', () => this.exportData());
          document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('import-file').click();
          });
          document.getElementById('import-file').addEventListener('change', (e) => {
            this.importData(e.target.files[0]);
          });
          
          // Daily goal
          document.getElementById('daily-goal-select').addEventListener('change', (e) => {
            this.gamification.stats.dailyGoal = parseInt(e.target.value);
            this.gamification.save();
            this.renderProfile();
          });
        }
        
        setupServiceWorker() {
          if ('serviceWorker' in navigator) {
            const swCode = `
              const CACHE = 'learnflow-v2';
              self.addEventListener('install', e => self.skipWaiting());
              self.addEventListener('activate', e => e.waitUntil(clients.claim()));
              self.addEventListener('fetch', e => {
                e.respondWith(
                  caches.match(e.request).then(r => r || fetch(e.request).then(res => {
                    return caches.open(CACHE).then(cache => {
                      cache.put(e.request, res.clone());
                      return res;
                    });
                  })).catch(() => caches.match('/'))
                );
              });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob))
              .then(() => console.log('SW registered'))
              .catch(e => console.log('SW failed:', e));
          }
        }
        
        switchView(view) {
          this.currentView = view;
          
          document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.view === view);
          });
          
          document.getElementById('feed-viewport').style.display = view === 'feed' ? 'block' : 'none';
          document.getElementById('knowledge-view').classList.toggle('active', view === 'knowledge');
          document.getElementById('profile-view').classList.toggle('active', view === 'profile');
          
          if (view === 'knowledge') {
            this.renderKnowledge();
          } else if (view === 'profile') {
            this.renderProfile();
          }
        }
        
        async loadFeed() {
          if (this.isLoading) return;
          this.isLoading = true;
          
          try {
            const promises = Array(CONFIG.FEED_BATCH_SIZE).fill(null).map(() => this.fetcher.fetch());
            const items = (await Promise.all(promises)).filter(Boolean);
            const ranked = this.personalization.rank(items);
            
            this.feedCache.push(...ranked);
            
            ranked.forEach(async item => {
              await this.storage.put('feed_cache', item);
            });
            
            this.renderFeed();
          } catch (e) {
            console.error('Feed error:', e);
          } finally {
            this.isLoading = false;
          }
        }
        
        renderFeed() {
          const container = document.getElementById('feed-container');
          container.innerHTML = '';
          
          this.feedCache.forEach((item, index) => {
            const card = this.createFeedCard(item, index);
            container.appendChild(card);
          });
          
          // Set first card as active
          if (this.feedCache.length > 0) {
            container.firstElementChild?.classList.add('active');
          }
        }
        
        createFeedCard(item, index) {
          const card = document.createElement('div');
          card.className = 'feed-card';
          card.dataset.index = index;
          
          card.innerHTML = `
            <div class="card-bg-gradient"></div>
            <div class="card-content-wrapper">
              <div class="card-category">${item.category}</div>
              <h1 class="card-title">${item.title}</h1>
              <p class="card-summary">${item.summary}</p>
              <div class="card-meta">
                <div class="card-meta-item">
                  <span class="card-meta-icon">üìñ</span>
                  <span>${item.readingTime} min read</span>
                </div>
                <div class="card-meta-item">
                  <span class="card-meta-icon">üè∑Ô∏è</span>
                  <span>${item.source}</span>
                </div>
              </div>
              <div class="card-tags">
                ${item.tags?.map(tag => `<div class="tag">${tag}</div>`).join('') || ''}
              </div>
            </div>
            <div class="side-actions">
              <button class="action-btn" data-action="like">
                ‚ù§Ô∏è
                <div class="action-count">0</div>
              </button>
              <button class="action-btn" data-action="save">
                üíæ
                <div class="action-count">0</div>
              </button>
              <button class="action-btn" data-action="expand">
                üìñ
              </button>
              <button class="action-btn" data-action="share">
                üì§
              </button>
            </div>
          `;
          
          // Action handlers
          card.querySelectorAll('[data-action]').forEach(btn => {
            btn.addEventListener('click', () => this.handleAction(btn.dataset.action, item, btn));
          });
          
          return card;
        }
        
        async handleAction(action, item, btn) {
          switch (action) {
            case 'like':
              btn.classList.toggle('active');
              if (btn.classList.contains('active')) {
                await this.personalization.recordLike(item.tags);
                this.gamification.recordRead();
                this.toast('Liked!', 'success');
              }
              break;
              
            case 'save':
              await this.saveItem(item);
              btn.classList.add('active');
              this.toast('Saved to library', 'success');
              break;
              
            case 'expand':
              this.showExpanded(item);
              break;
              
            case 'share':
              if (navigator.share) {
                try {
                  await navigator.share({
                    title: item.title,
                    text: item.summary,
                    url: item.url || window.location.href
                  });
                } catch (e) {}
              } else {
                navigator.clipboard.writeText(item.title + '\n\n' + item.summary);
                this.toast('Copied to clipboard', 'success');
              }
              break;
          }
        }
        
        showExpanded(item) {
          this.currentItem = item;
          const panel = document.getElementById('expanded-content');
          const body = document.getElementById('expanded-body');
          
          body.innerHTML = `
            <h1 style="font-size: var(--text-3xl); font-weight: 800; margin-bottom: var(--space-4);">${item.title}</h1>
            <div class="card-meta" style="margin-bottom: var(--space-6);">
              <div class="card-meta-item">
                <span class="card-meta-icon">üìñ</span>
                <span>${item.readingTime} min read</span>
              </div>
              <div class="card-meta-item">
                <span class="card-meta-icon">üè∑Ô∏è</span>
                <span>${item.source}</span>
              </div>
            </div>
            <div class="expanded-text">
              ${item.content.split('\n\n').map(p => `<p>${p}</p>`).join('')}
            </div>
            ${item.url ? `<a href="${item.url}" target="_blank" class="btn btn-secondary" style="margin-top: var(--space-6);">üîó View Source</a>` : ''}
          `;
          
          panel.classList.add('visible');
          this.gamification.recordRead();
        }
        
        async saveItem(item) {
          const saved = {
            ...item,
            savedAt: Date.now()
          };
          
          await this.storage.put('saved_items', saved);
          this.gamification.recordSave();
          await this.personalization.recordLike(item.tags);
          await this.updateLibraryBadge();
          await this.search.buildIndex();
        }
        
        async renderKnowledge(items = null) {
          if (!items) {
            const saved = await this.storage.getAll('saved_items');
            const notes = await this.storage.getAll('notes');
            items = [...saved, ...notes].sort((a, b) => (b.savedAt || b.timestamp) - (a.savedAt || a.timestamp));
          }
          
          const grid = document.getElementById('knowledge-grid');
          
          if (items.length === 0) {
            grid.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">üìö</div>
                <div class="empty-title">No items yet</div>
                <div class="empty-desc">Save items from the feed to build your library</div>
              </div>
            `;
            return;
          }
          
          grid.innerHTML = items.map(item => `
            <div class="knowledge-card" data-id="${item.id}">
              <div class="knowledge-card-title">${item.title}</div>
              <div class="knowledge-card-date">${new Date(item.savedAt || item.timestamp).toLocaleDateString()}</div>
            </div>
          `).join('');
          
          grid.querySelectorAll('.knowledge-card').forEach(card => {
            card.addEventListener('click', () => {
              this.showItemDetail(parseInt(card.dataset.id));
            });
          });
        }
        
        async showItemDetail(id) {
          const saved = await this.storage.getAll('saved_items');
          const notes = await this.storage.getAll('notes');
          const item = [...saved, ...notes].find(i => i.id === id);
          
          if (!item) return;
          
          const modal = document.getElementById('modal-overlay');
          const title = document.getElementById('modal-title');
          const body = document.getElementById('modal-body');
          
          title.textContent = item.title;
          body.innerHTML = `
            <div style="margin-bottom: var(--space-4);">
              ${item.tags?.map(tag => `<span class="tag">${tag}</span>`).join('') || ''}
            </div>
            <div class="expanded-text">
              ${(item.content || item.summary || '').split('\n\n').map(p => `<p>${p}</p>`).join('')}
            </div>
            <div style="margin-top: var(--space-6); display: flex; gap: var(--space-3);">
              ${item.url ? `<a href="${item.url}" target="_blank" class="btn btn-secondary">üîó Source</a>` : ''}
              <button class="btn btn-secondary" id="delete-item">üóëÔ∏è Delete</button>
            </div>
          `;
          
          modal.classList.add('active');
          
          const deleteBtn = document.getElementById('delete-item');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', async () => {
              if (confirm('Delete this item?')) {
                const store = item.savedAt ? 'saved_items' : 'notes';
                await this.storage.delete(store, id);
                await this.updateLibraryBadge();
                await this.search.buildIndex();
                modal.classList.remove('active');
                this.toast('Item deleted', 'success');
                if (this.currentView === 'knowledge') {
                  this.renderKnowledge();
                }
              }
            });
          }
        }
        
        async handleSearch(query) {
          if (!query) {
            this.renderKnowledge();
            return;
          }
          
          const results = await this.search.search(query);
          this.renderKnowledge(results);
        }
        
        async filterKnowledge(filter) {
          let items;
          
          if (filter === 'all') {
            const saved = await this.storage.getAll('saved_items');
            const notes = await this.storage.getAll('notes');
            items = [...saved, ...notes];
          } else if (filter === 'saved') {
            items = await this.storage.getAll('saved_items');
          } else if (filter === 'notes') {
            items = await this.storage.getAll('notes');
          } else if (filter === 'recent') {
            const saved = await this.storage.getAll('saved_items');
            const notes = await this.storage.getAll('notes');
            const all = [...saved, ...notes];
            const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            items = all.filter(i => (i.savedAt || i.timestamp) > weekAgo);
          }
          
          items = items.sort((a, b) => (b.savedAt || b.timestamp) - (a.savedAt || a.timestamp));
          this.renderKnowledge(items);
        }
        
        showNoteModal() {
          const modal = document.getElementById('modal-overlay');
          const title = document.getElementById('modal-title');
          const body = document.getElementById('modal-body');
          
          title.textContent = 'Create Note';
          body.innerHTML = `
            <form id="note-form">
              <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="form-input" id="note-title" required>
              </div>
              <div class="form-group">
                <label class="form-label">Content</label>
                <textarea class="form-textarea" id="note-content" required></textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Tags (comma separated)</label>
                <input type="text" class="form-input" id="note-tags">
              </div>
              <button type="submit" class="btn btn-primary">üíæ Save Note</button>
            </form>
          `;
          
          modal.classList.add('active');
          
          document.getElementById('note-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const note = {
              title: document.getElementById('note-title').value,
              content: document.getElementById('note-content').value,
              tags: document.getElementById('note-tags').value.split(',').map(t => t.trim()).filter(Boolean),
              timestamp: Date.now()
            };
            
            await this.storage.put('notes', note);
            this.gamification.recordNote();
            await this.updateLibraryBadge();
            await this.search.buildIndex();
            
            modal.classList.remove('active');
            this.toast('Note created', 'success');
          });
        }
        
        renderProfile() {
          const stats = this.gamification.stats;
          
          document.getElementById('user-level').textContent = stats.level;
          document.getElementById('user-xp').textContent = stats.xp;
          document.getElementById('user-rank').textContent = this.gamification.getRank();
          document.getElementById('user-streak').textContent = stats.streak;
          
          document.getElementById('stat-learned').textContent = stats.learned;
          document.getElementById('stat-saved').textContent = stats.saved;
          document.getElementById('stat-notes').textContent = stats.notes;
          document.getElementById('stat-time').textContent = Math.floor(stats.time / 60);
          
          const progress = this.gamification.getDailyProgress();
          document.getElementById('daily-progress').textContent = progress;
          document.getElementById('daily-progress-fill').style.width = progress + '%';
          
          const grid = document.getElementById('achievements-grid');
          grid.innerHTML = this.gamification.achievements.map(ach => `
            <div class="achievement-card ${ach.unlocked ? 'unlocked' : 'locked'}">
              <div class="achievement-icon">${ach.icon}</div>
              <div class="achievement-name">${ach.name}</div>
            </div>
          `).join('');
        }
        
        async updateLibraryBadge() {
          const saved = await this.storage.getAll('saved_items');
          const notes = await this.storage.getAll('notes');
          const count = saved.length + notes.length;
          document.getElementById('library-badge').textContent = count;
        }
        
        handleFeedScroll() {
          const container = document.getElementById('feed-container');
          const scrollTop = container.scrollTop;
          const scrollHeight = container.scrollHeight;
          const clientHeight = container.clientHeight;
          
          // Update active card
          const cards = container.querySelectorAll('.feed-card');
          cards.forEach(card => {
            const rect = card.getBoundingClientRect();
            if (rect.top >= 0 && rect.top < clientHeight / 2) {
              cards.forEach(c => c.classList.remove('active'));
              card.classList.add('active');
            }
          });
          
          // Load more
          if (scrollHeight - scrollTop - clientHeight < 1000) {
            this.loadFeed();
          }
        }
        
        async exportData() {
          const data = {
            version: 2,
            timestamp: Date.now(),
            saved_items: await this.storage.getAll('saved_items'),
            notes: await this.storage.getAll('notes'),
            achievements: await this.storage.getAll('achievements'),
            settings: await this.storage.getAll('settings')
          };
          
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `learnflow-${Date.now()}.json`;
          a.click();
          URL.revokeObjectURL(url);
          
          this.toast('Data exported', 'success');
        }
        
        async importData(file) {
          if (!file) return;
          
          try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (data.saved_items) {
              for (const item of data.saved_items) {
                await this.storage.put('saved_items', item);
              }
            }
            
            if (data.notes) {
              for (const note of data.notes) {
                await this.storage.put('notes', note);
              }
            }
            
            if (data.achievements) {
              for (const ach of data.achievements) {
                await this.storage.put('achievements', ach);
              }
            }
            
            if (data.settings) {
              for (const setting of data.settings) {
                await this.storage.put('settings', setting);
              }
            }
            
            await this.gamification.init();
            await this.search.buildIndex();
            await this.updateLibraryBadge();
            this.renderProfile();
            
            this.toast('Data imported', 'success');
          } catch (e) {
            this.toast('Import failed', 'error');
          }
        }
        
        toast(message, type = 'success') {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          
          const icon = type === 'success' ? '‚úì' : '‚úï';
          toast.innerHTML = `
            <div class="toast-icon">${icon}</div>
            <div class="toast-message">${message}</div>
          `;
          
          container.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        }
        
        debounce(func, wait) {
          let timeout;
          return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
          };
        }
      }
      
      // ============================================
      // INITIALIZE
      // ============================================
      const app = new App();
      window.app = app;
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => app.init());
      } else {
        app.init();
      }
      
      // Online/offline handlers
      window.addEventListener('online', () => {
        app.toast('Back online', 'success');
        app.loadFeed();
      });
      
      window.addEventListener('offline', () => {
        app.toast('You are offline', 'error');
      });
      
    })();
  </script>
</body>
</html>
