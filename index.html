<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR UI Mockup Pro</title>
    <!-- A-Frame and AR.js libraries -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background-color: #000; }
        #ui-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            display: none; /* Hidden until AR starts */
        }
        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
        }
        #permission-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            text-align: center;
            padding: 20px;
        }
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 45px;
            height: 45px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Ensure the video feed fills the screen correctly */
        .a-canvas {
            width: 100% !important;
            height: 100% !important;
            top: 0 !important;
            left: 0 !important;
        }
    </style>
</head>
<body>

    <!-- Permission/Start Screen -->
    <div id="permission-screen">
        <div class="mb-6 bg-blue-500/10 p-5 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </div>
        <h1 class="text-2xl font-bold mb-2">AR UI Previewer</h1>
        <p class="text-slate-400 mb-8 max-w-xs">We need camera access to project the UI onto your physical tracker.</p>
        <button id="start-ar-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-4 rounded-2xl font-bold text-lg transition-all active:scale-95 shadow-xl shadow-blue-500/20">
            Enable Camera & Start
        </button>
    </div>

    <!-- Loading Screen (for Generation) -->
    <div id="loading-screen">
        <div class="spinner mb-4"></div>
        <p id="loading-text" class="font-medium">Designing your UI...</p>
    </div>

    <!-- AR Scene (Initially empty, injected on start) -->
    <div id="scene-container"></div>

    <!-- UI Interaction Overlay -->
    <div id="ui-overlay" class="glass p-6 text-white">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-lg font-bold">UI Generator</h2>
                <p class="text-[10px] uppercase tracking-wider text-blue-400 font-semibold">Live AR View</p>
            </div>
            <div class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></div>
        </div>
        
        <div class="flex flex-col gap-3">
            <textarea 
                id="prompt-input" 
                rows="2" 
                placeholder="e.g. A futuristic crypto wallet dashboard..."
                class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-white/30"
            ></textarea>
            <button 
                id="generate-btn"
                class="w-full bg-blue-600 hover:bg-blue-500 transition-colors py-3 rounded-xl font-semibold shadow-lg active:scale-95 flex items-center justify-center gap-2"
            >
                <span>Generate UI</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.21 0 4-1.79 4-4.02 0-1.66-1.35-3.02-3-3.02Z"/></svg>
            </button>
        </div>
        <p class="text-[10px] text-center mt-3 text-white/40 italic">Point camera at a Hiro marker</p>
    </div>

    <script>
        const apiKey = ""; 
        const startArBtn = document.getElementById('start-ar-btn');
        const permissionScreen = document.getElementById('permission-screen');
        const uiOverlay = document.getElementById('ui-overlay');
        const loadingScreen = document.getElementById('loading-screen');
        const promptInput = document.getElementById('prompt-input');
        const generateBtn = document.getElementById('generate-btn');
        const sceneContainer = document.getElementById('scene-container');

        let uiPlane = null;
        let uiTexture = null;

        // Initialize the AR Scene only after button click to ensure camera access is granted
        function initAR() {
            permissionScreen.style.display = 'none';
            uiOverlay.style.display = 'block';

            const sceneHTML = `
                <a-scene 
                    embedded 
                    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
                    vr-mode-ui="enabled: false"
                    renderer="antialias: true; alpha: true; precision: medium; logarithmicDepthBuffer: true;"
                >
                    <a-assets>
                        <img id="ui-texture" src="https://via.placeholder.com/512x768.png?text=UI+Target+Active">
                    </a-assets>

                    <a-marker preset="hiro" id="ui-marker">
                        <a-plane 
                            id="ui-plane"
                            position="0 0.2 0" 
                            rotation="-90 0 0" 
                            width="2" 
                            height="3" 
                            material="src: #ui-texture; transparent: true; opacity: 0.95; shader: flat; side: double;"
                            animation="property: position; to: 0 0.3 0; dir: alternate; dur: 2000; loop: true; easing: easeInOutSine"
                        >
                        </a-plane>
                        <a-ring color="#3b82f6" radius-inner="1.05" radius-outer="1.1" rotation="-90 0 0" opacity="0.5"></a-ring>
                    </a-marker>

                    <a-entity camera></a-entity>
                </a-scene>
            `;
            
            sceneContainer.innerHTML = sceneHTML;
            
            // Wait for components to load
            setTimeout(() => {
                uiPlane = document.getElementById('ui-plane');
                uiTexture = document.getElementById('ui-texture');
            }, 1000);
        }

        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                    if (response.status === 429) {
                        await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                        continue;
                    }
                } catch (e) {}
            }
            throw new Error("API Limit Reached");
        }

        async function generateUIMockup() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            loadingScreen.style.display = 'flex';
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
                
                const uiPrompt = `Professional, sleek mobile app user interface mockup for: ${prompt}. Modern glassmorphism style, high resolution 2D dashboard, clean vertical layout, UI/UX design, mobile screen aspect ratio.`;

                const data = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instances: { prompt: uiPrompt },
                        parameters: { sampleCount: 1 }
                    })
                });

                if (data.predictions && data.predictions[0].bytesBase64Encoded) {
                    const base64Image = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    
                    // Directly update the A-Frame element
                    if (uiPlane) {
                        uiPlane.setAttribute('material', 'src', base64Image);
                    }
                }
            } catch (error) {
                console.error("Generation failed:", error);
                showToast("Generation failed. Please check your connection.");
            } finally {
                loadingScreen.style.display = 'none';
            }
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = "fixed top-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-2xl z-[4000] shadow-2xl border border-white/10 text-sm";
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        startArBtn.addEventListener('click', initAR);
        generateBtn.addEventListener('click', generateUIMockup);

        window.addEventListener('resize', () => {
            const scene = document.querySelector('a-scene');
            if (scene) scene.resize();
        });
    </script>
</body>
</html>

